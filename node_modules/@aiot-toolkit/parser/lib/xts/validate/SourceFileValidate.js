"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _sharedUtils = require("@aiot-toolkit/shared-utils");
var _classCount = _interopRequireDefault(require("../config/classCount.json"));
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
/**
 * 校验文件中的特殊类
 * ClassCountValidate
 */
class SourceFileValidate {
  validate(context, fileName) {
    const {
      sourceFile,
      onLog
    } = context;
    const ruleIndex = _classCount.default.findIndex(item => new RegExp(item.name).test(fileName));
    const rules = _classCount.default[ruleIndex].rule;
    rules.map(rule => {
      if (rule.classDecorator) {
        const spDecorator = rule.classDecorator;
        // 检查所有类中，特殊类是不是只出现了规则限制的次数
        const classNodes = sourceFile.getClasses();
        let countSpClass = 0;
        for (const classNode of classNodes) {
          const classDec = classNode.getDecorator(spDecorator);
          classDec?.getText() === rule.value && countSpClass++;
          if (countSpClass < rule.min || countSpClass > rule.max) {
            classDec && onLog({
              message: `${rule.keyword} modifier appears too many times`,
              level: _sharedUtils.Loglevel.ERROR
            });
          }
        }
      }
    });
    return [];
  }
}
var _default = exports.default = SourceFileValidate;