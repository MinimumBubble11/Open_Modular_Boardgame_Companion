const vdom_pb = require('./vdom_pb')
const Path = require('path')
const fs = require('fs')
const AIOT = require('./protobuf')

/**
 *
 * @param {[[[number, string]], {[key:string]:string|number}][]} style
 */
function translateStyle(style, aiot) {
  const exportCell = aiot.expCell

  style.forEach((item) => {
    const hasProperty = item.length === 3
    let property
    let selectorList = item[0]
    let styleValue = item[1]
    if (hasProperty) {
      property = item[0]
      selectorList = item[1]
      styleValue = item[2]
    }

    const cssCell = exportCell.addCssarr()

    // 如果有 property，写入
    if (hasProperty && property) {
      Object.keys(property).forEach((key) => {
        const value = property[key]
        const propertyArr = cssCell.addPropertyarr()
        // 设置属性名
        const propertyKey = new vdom_pb.StyleKey()
        propertyKey.setValue(key)
        propertyArr.setKey(propertyKey)

        // 设置属性值
        switch (typeof value) {
          case 'string':
            propertyArr.setStringvl(value)
            break
          case 'number':
            if (Number.isInteger(value)) {
              propertyArr.setInt32vl(value)
            } else {
              propertyArr.setDoublevl(value)
            }
            break
        }
      })
    }

    // 写入选择器
    selectorList.forEach((selectorItem) => {
      const selector = cssCell.addSelectorarr()
      selector.setId(selectorItem[0])
      selector.setName(selectorItem[1])
    })

    // 写入属性值
    Object.keys(styleValue).forEach((key) => {
      const value = styleValue[key]

      const styleVl = cssCell.addStylearr()

      // 设置css属性名称
      const pk = new vdom_pb.StyleKey()
      pk.setValue(key)
      styleVl.setKey(pk)

      const valueType = typeof value
      // 设置css值
      switch (valueType) {
        case 'string':
          styleVl.setStringvl(value)
          break
        case 'number':
          if (Number.isInteger(value)) {
            styleVl.setInt32vl(value)
          } else {
            styleVl.setDoublevl(value)
          }
          break
        case 'object':
          styleVl.setStylevlarr(aiot.parseObj(value))
          break
        default:
          console.warn(`CssValue Of ${valueType} NotProcessed`)
      }
    })
  })
  return exportCell
}

function translateTemplate(template, aiot) {
  const vm = {}
  if (template) {
    // eslint-disable-next-line no-eval
    eval(`(${template})`)(vm)
  }
}

function createItem(entryName, style, template) {
  // 创建aiot对象
  let aiot = new AIOT()
  aiot.init(entryName || 'entry')
  // 写入template
  translateTemplate(template, aiot)
  // 写入style
  translateStyle(style, aiot)

  return aiot
}

/**
 *
 * @param {*} template
 */
function extractFunctions(template) {
  // 创建aiot对象
  let aiot = new AIOT()
  aiot.init('temp')

  // 写入template
  translateTemplate(template, aiot)

  return aiot
}

/**
 * 创建bin文件
 * @param {string} fileName
 * @param {string[]} styleList
 * @param {string[]} templateList
 */
function createBin(fileName, tagList, styleList, templateList) {
  const dataList = styleList.map((item, index) => {
    return createItem(tagList[index], JSON.parse(item), templateList[index])
  })

  // 写入数据
  let indexExport = new vdom_pb.ExportArr()
  indexExport.clearValuearrList()
  dataList.forEach((item) => {
    indexExport.addValuearr(item.expCell)
  })

  // 如果文件夹不存在，则创建
  const folder = Path.dirname(fileName)
  if (!fs.existsSync(folder)) {
    fs.mkdirSync(folder, { recursive: true })
  }
  // 写入文件
  let outbuff = indexExport.serializeBinary()
  fs.writeFileSync(fileName, outbuff)
}
module.exports = {
  extractFunctions,
  createBin
}
