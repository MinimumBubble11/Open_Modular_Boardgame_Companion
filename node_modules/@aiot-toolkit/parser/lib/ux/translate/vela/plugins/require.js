"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = translateRequire;
var _sharedUtils = require("@aiot-toolkit/shared-utils");
var t = _interopRequireWildcard(require("@babel/types"));
var _FeatureConfig = _interopRequireDefault(require("../../../config/FeatureConfig"));
var _StyleUtil = _interopRequireDefault(require("../../../utils/StyleUtil"));
var _path = _interopRequireDefault(require("path"));
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && {}.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
function translateRequire() {
  return {
    visitor: {
      CallExpression(path, _ref) {
        let {
          opts
        } = _ref;
        const {
          node
        } = path;
        const options = 'options' in opts && opts.options || undefined;
        const compilerOption = opts.compilerOption;
        const systemFeatures = 'systemFeatures' in opts && opts.systemFeatures || undefined;
        // 判断当前函数调用是否为require函数调用
        if (t.isIdentifier(node.callee) && node.callee.name === 'require') {
          const argus = node.arguments;
          argus.forEach(arguNode => {
            // 取参数值
            if (t.isStringLiteral(arguNode)) {
              const arguValue = arguNode.value.trim();
              if (_FeatureConfig.default.isSystemModule(arguValue)) {
                ;
                node.callee.name = '$app_require$';
                arguNode.value = `@app-module/${arguValue.slice(1)}`;
                // 添加全局system feature
                if (!systemFeatures) {
                  _sharedUtils.ColorConsole.throw('translateRequire error: systemFeatures is undefined');
                } else {
                  systemFeatures.add(arguValue.slice(1));
                }
              } else if (arguValue.endsWith('.so') || arguValue.endsWith('.dll')) {
                ;
                node.callee.name = '$native_require$';
                // ?需要检查路径存不存在吗？
                if (options) {
                  const relativePath = _StyleUtil.default.getRelativePath(arguValue, options, compilerOption);
                  // 转换结果与1.0同步，移除相对路径前的第一个斜杠
                  arguNode.value = relativePath.startsWith(_path.default.posix.sep) ? relativePath.slice(1) : relativePath;
                } else {
                  _sharedUtils.ColorConsole.throw('translateRequire error: options is undefined');
                }
              }
            }
          });
        }
      }
    }
  };
}