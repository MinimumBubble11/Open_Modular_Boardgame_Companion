"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.preInstall = void 0;
var _sharedUtils = require("@aiot-toolkit/shared-utils");
var _child_process = require("child_process");
var _fs = _interopRequireDefault(require("fs"));
var _path = _interopRequireDefault(require("path"));
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
const preInstall = async params => {
  const {
    context,
    compilerOption
  } = params;
  if (compilerOption?.skip?.includes('install')) {
    _sharedUtils.ColorConsole.info(`### skip install pre-dependencies due to --skip ${compilerOption?.skip.join(',')}`);
    return;
  }
  const {
    projectPath
  } = context;
  const packagePath = _path.default.resolve(projectPath, 'package.json');
  const preContent = {
    dependencies: {
      '@mi/ts-framework': 'https://pkgs.d.xiaomi.net:443/artifactory/api/npm/mi-npm/@mi/ts-framework/-/@mi/ts-framework-1.0.9.tgz',
      '@mi/wasmnizer-ts': 'https://pkgs.d.xiaomi.net:443/artifactory/api/npm/mi-npm/@mi/wasmnizer-ts/-/@mi/wasmnizer-ts-0.0.12.tgz'
    }
  };
  if (!_fs.default.existsSync(packagePath)) {
    /** 如果没有 package.json 则创建 */
    _fs.default.writeFileSync(packagePath, JSON.stringify(preContent, undefined, 2), {
      encoding: 'utf-8'
    });
  } else {
    const pckageContent = require(packagePath);
    if (!pckageContent.dependencies['@mi/ts-framework'] || !pckageContent.dependencies['@mi/wasmnizer-ts']) {
      Object.assign(pckageContent, preContent);
      _fs.default.writeFileSync(packagePath, JSON.stringify(pckageContent), {
        encoding: 'utf-8'
      });
    }
  }
  _sharedUtils.ColorConsole.info('### Installing pre-dependencies. The initial build may take some time, please be patient...');
  (0, _child_process.execSync)('npm install', {
    cwd: projectPath
  });

  // 目前ts2wasm不支持@符号
  _fs.default.renameSync(_path.default.resolve(projectPath, 'node_modules/@mi'), _path.default.resolve(projectPath, 'node_modules/mi'));
  _sharedUtils.ColorConsole.info('### Dependencies installation complete.');
};
exports.preInstall = preInstall;