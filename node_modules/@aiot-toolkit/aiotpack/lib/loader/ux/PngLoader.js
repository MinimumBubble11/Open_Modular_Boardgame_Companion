"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _sharedUtils = require("@aiot-toolkit/shared-utils");
var _path = _interopRequireDefault(require("path"));
var _PngUtils = _interopRequireDefault(require("../../utils/PngUtils"));
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
const aaptjs = require('@hap-toolkit/aaptjs');

/**
 * PngLoader
 */
class PngLoader {
  async parser(files) {
    const resultFiles = [];
    for (const file of files) {
      const {
        path: filePath,
        content
      } = file;
      const {
        name,
        ext
      } = _path.default.parse(filePath);
      const fullName = `${name}${ext}`;
      //判断文本，空文本则结束该文件处理
      if (!content) {
        _sharedUtils.ColorConsole.warn(`The file '${fullName}' under the path '${filePath}' has no content `);
        return [];
      }
      // 判断传入的.png资源是不是.9.png资源
      if (_sharedUtils.FileUtil.match(filePath, /.+\.9\.png$/)) {
        await this.compile9Png(filePath);
      } else {
        resultFiles.push(file);
      }
    }
    return resultFiles;
  }
  async compile9Png(filePath) {
    // 判断.9.png是否经过编码处理
    if (!_PngUtils.default.isEncode9Png(filePath)) {
      // 将.9.png资源使用@hap-toolkit/aaptjs处理
      const outputFile = _PngUtils.default.convertOutputPath(filePath, this.context);
      try {
        await aaptjs.singleCrunch(filePath, outputFile);
      } catch (error) {
        _sharedUtils.ColorConsole.throw(`.9.png resource file processing failed`);
      }
    }
  }
}
;
PngLoader.raw = true;
var _default = exports.default = PngLoader;