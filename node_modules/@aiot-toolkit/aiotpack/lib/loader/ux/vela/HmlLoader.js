"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _path = _interopRequireDefault(require("path"));
var _fs = _interopRequireDefault(require("fs"));
var _parser = require("@aiot-toolkit/parser");
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
/**
 * HmlLoader
 */
class HmlLoader {
  parser(files) {
    return files.map(file => {
      return this.wrapHml(file);
    });
  }

  /**
   * 包裹 hml 文件
   *
   * # 路径
   * 如果存在同路径的 ux 后缀，报错；否则转换为同路径的 ux 后缀
   *
   * # 内容
   * 1. 给hml的内容加上<template></template>
   * 2. 如果存在同路径同名的 script文件，则加到<script></script>中
   * 3. 如果存在同路径同名的 style文件，则加到<style></style>中
   *
   * @param file
   */
  wrapHml(file) {
    const {
      path,
      content
    } = file;
    const uxExt = _parser.ExtensionConfig.UX;
    const getFilePath = ext => {
      const pathParsed = _path.default.parse(path);
      pathParsed.ext = ext;
      pathParsed.base = pathParsed.name + ext;
      return _path.default.format(pathParsed);
    };
    const uxPath = getFilePath(uxExt);
    if (_fs.default.existsSync(uxPath)) {
      throw new Error(`${uxPath} already exists`);
    }
    const scriptExts = _parser.ExtensionConfig.SCRIPTS;
    const styleExts = _parser.ExtensionConfig.STYLES;
    const scriptPath = scriptExts.map(item => getFilePath(item)).find(item => _fs.default.existsSync(item));
    const stylePath = styleExts.map(item => getFilePath(item)).find(item => _fs.default.existsSync(item));
    let uxContent = ['<template>', content, '</template>'].join('\n');
    if (scriptPath) {
      uxContent += ['<script>', _fs.default.readFileSync(scriptPath, 'utf-8'), '</script>'].join('\n');
    }
    if (stylePath) {
      uxContent += ['<style>', _fs.default.readFileSync(stylePath, 'utf-8'), '</style>'].join('\n');
    }
    return {
      path,
      content: uxContent
    };
  }
}
var _default = exports.default = HmlLoader;